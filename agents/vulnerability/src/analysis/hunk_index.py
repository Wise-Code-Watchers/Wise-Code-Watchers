"""
Hunk索引模块 - 建立feature_risk_plan与diff_ir之间的映射关系
用于解决调度选择阶段字段不匹配的问题
"""

from typing import Any, Dict, List, Optional, Tuple

import re


def build_hunk_index(diff_ir: Dict[str, Any]) -> Dict[str, Dict[str, Any]]:
    """从diff_ir构建hunk_id到详情的映射"""
    index: Dict[str, Dict[str, Any]] = {}
    files = diff_ir.get("files", [])

    for f_idx, f in enumerate(files):
        file_path = f.get("file_path")
        language = f.get("language")
        change_type = f.get("change_type")
        is_binary = f.get("is_binary", False)

        for h_idx, h in enumerate(f.get("hunks", [])):
            hid = f"{f_idx}:{h_idx}"
            index[hid] = {
                "hunk_id": hid,
                "file_path": file_path,
                "language": language,
                "change_type": change_type,
                "is_binary": is_binary,
                "hunk": h,
                "old_start": h.get("old_start"),
                "old_count": h.get("old_count"),
                "new_start": h.get("new_start"),
                "new_count": h.get("new_count"),
                "header": h.get("header", "")
            }

    return index


def hunk_text_from_diff_hunk(hunk: Dict[str, Any], max_lines: int = 160) -> str:
    """从diff_ir的hunk结构提取文本内容"""
    lines = hunk.get("lines", [])
    out = []

    for ln in lines[:max_lines]:
        content = ln.get("content", "")
        if content:
            line_type = ln.get("type", "")
            if line_type == "add":
                prefix = "+"
            elif line_type == "del":
                prefix = "-"
            else:
                prefix = " "

            old_no = ln.get("old_lineno")
            new_no = ln.get("new_lineno")

            out.append(f"{prefix} (old:{old_no}, new:{new_no}) {content}")

    return "\n".join(out)


def _trim_middle(lines: List[str], max_lines: int = 220) -> List[str]:
    """Trim a list of lines by keeping head+tail and inserting an ellipsis."""
    if max_lines <= 0 or len(lines) <= max_lines:
        return lines
    # Keep 2/3 head, 1/3 tail
    head = max(5, int(max_lines * 0.67))
    tail = max(5, max_lines - head - 1)
    return lines[:head] + ["...|..."] + lines[-tail:]


def build_line_candidates_from_hunk(hunk: Dict[str, Any]) -> List[Dict[str, Any]]:
    """Build commentable line candidates (RIGHT side) from a diff_ir hunk.

    Returns entries like:
      {"line": int, "content": str, "type": "add"|"context"}
    """
    candidates: List[Dict[str, Any]] = []
    for ln in hunk.get("lines", []):
        t = ln.get("type")
        new_no = ln.get("new_lineno")
        if new_no is None:
            continue
        if t not in ("add", "context"):
            continue
        content = (ln.get("content") or "").rstrip("\n")
        candidates.append({"line": int(new_no), "content": content, "type": t})
    return candidates


def format_hunk_for_prompt_with_line_numbers(
    file_path: str,
    hunk: Dict[str, Any],
    max_lines: int = 220,
) -> str:
    """Render a diff_ir hunk into a prompt-friendly, line-addressable view.

    Format:
      File: path
         12| unchanged line (new side)
      -  18| deleted line (old side)
      +  19| added line (new side)

    Notes:
    - For context/add lines, we show new_lineno.
    - For del lines, we show old_lineno.
    - This allows the model to cite exact line numbers.
    """
    out: List[str] = [f"File: {file_path}"]

    rendered: List[str] = []
    for ln in hunk.get("lines", []):
        t = ln.get("type")
        content = (ln.get("content") or "").rstrip("\n")
        if t == "add":
            no = ln.get("new_lineno")
            rendered.append(f"+{no:>5}|{content}" if no is not None else f"+    ?|{content}")
        elif t == "del":
            no = ln.get("old_lineno")
            rendered.append(f"-{no:>5}|{content}" if no is not None else f"-    ?|{content}")
        else:
            no = ln.get("new_lineno")
            rendered.append(f" {no:>5}|{content}" if no is not None else f"     ?|{content}")

    rendered = _trim_middle(rendered, max_lines=max_lines)
    out.extend(rendered)
    return "\n".join(out)


def format_snippet_with_line_numbers(
    snippet: str,
    start_line: int,
    max_lines: int = 220,
) -> str:
    """Render a plain file snippet by prefixing absolute line numbers."""
    raw_lines = snippet.splitlines()
    rendered: List[str] = []
    for i, line in enumerate(raw_lines):
        rendered.append(f"{start_line + i:>5}|{line}")
    rendered = _trim_middle(rendered, max_lines=max_lines)
    return "\n".join(rendered)


def extract_new_lines(hunk: Dict[str, Any]) -> List[int]:
    """提取hunk中的新增行号"""
    new_lines = []

    for ln in hunk.get("lines", []):
        if ln.get("type") == "add" and ln.get("new_lineno"):
            new_lines.append(ln["new_lineno"])

    return new_lines


def get_hunk_line_range(hunk: Dict[str, Any]) -> Tuple[Optional[int], Optional[int]]:
    """获取完整hunk范围（包括context行）"""
    new_start = hunk.get("new_start")
    new_count = hunk.get("new_count", 0)

    if new_start is not None and new_count > 0:
        return new_start, new_start + new_count - 1

    new_lines = extract_new_lines(hunk)
    if new_lines:
        return min(new_lines), max(new_lines)

    return None, None


def get_hunk_risk_score(hunk: Dict[str, Any], feature_risk_plan: Dict[str, Any]) -> int:
    """从feature_risk_plan中查找hunk的风险分数"""
    hunk_id = hunk.get("hunk_id")

    for feature in feature_risk_plan.get("features", []):
        for h in feature.get("hunks", []):
            if h.get("hunk_id") == hunk_id:
                return int(h.get("risk_score", 0))

    return 0


def get_hunk_severity(hunk: Dict[str, Any], feature_risk_plan: Dict[str, Any]) -> str:
    """从feature_risk_plan中查找hunk的严重性级别"""
    hunk_id = hunk.get("hunk_id")

    for feature in feature_risk_plan.get("features", []):
        for h in feature.get("hunks", []):
            if h.get("hunk_id") == hunk_id:
                return h.get("severity", "info")

    return "info"


def filter_hunks_by_risk(hunks: List[Dict[str, Any]], risk_threshold: int = 35) -> List[Dict[str, Any]]:
    """按风险阈值过滤hunks"""
    return [h for h in hunks if int(h.get("risk_score", 0)) >= risk_threshold]


def select_hunks_from_top_focus(feature_risk_plan: Dict[str, Any], risk_threshold: int = 35, max_units: int = 10) -> List[str]:
    """从top_focus中选择hunk_id"""
    selected = []

    for item in feature_risk_plan.get("top_focus", []):
        hunk_id = item.get("hunk_id")
        risk_score = int(item.get("risk_score", 0) or 0)

        if risk_score >= risk_threshold and hunk_id and len(selected) < max_units:
            selected.append(hunk_id)

    return selected


def select_hunks_from_features(feature_risk_plan: Dict[str, Any], risk_threshold: int = 35, max_units: int = 10) -> List[str]:
    """从features中选择hunk_id"""
    selected = []

    for feature in feature_risk_plan.get("features", []):
        for hunk in feature.get("hunks", []):
            hunk_id = hunk.get("hunk_id")
            risk_score = int(hunk.get("risk_score", 0) or 0)

            if risk_score >= risk_threshold and hunk_id and len(selected) < max_units:
                selected.append(hunk_id)

    return selected


def select_security_targets(feature_risk_plan: Dict[str, Any], risk_threshold: int = 35, max_units: int = 10) -> List[Dict[str, Any]]:
    """选择Security Agent的目标hunks"""
    targets = []

    if feature_risk_plan.get("top_focus"):
        for item in feature_risk_plan["top_focus"]:
            hunk_id = item.get("hunk_id")
            risk_score = int(item.get("risk_score", 0) or 0)

            if risk_score >= risk_threshold and hunk_id:
                targets.append({
                    "hunk_id": hunk_id,
                    "risk_score": risk_score,
                    "reason": "top_focus",
                    "priority": item.get("priority", "medium")
                })

    if len(targets) < max_units:
        for feature in feature_risk_plan.get("features", []):
            for hunk in feature.get("hunks", []):
                hunk_id = hunk.get("hunk_id")
                risk_score = int(hunk.get("risk_score", 0) or 0)

                if risk_score >= risk_threshold and hunk_id and len(targets) < max_units:
                    targets.append({
                        "hunk_id": hunk_id,
                        "risk_score": risk_score,
                        "reason": "feature_hunks",
                        "priority": hunk.get("severity", "medium")
                    })

    return targets[:max_units]


def select_logic_targets(feature_risk_plan: Dict[str, Any], risk_threshold: int = 60, max_units: int = 12) -> List[Dict[str, Any]]:
    """选择Logic Agent的目标hunks"""
    targets = []

    if feature_risk_plan.get("top_focus"):
        for item in feature_risk_plan["top_focus"]:
            hunk_id = item.get("hunk_id")
            risk_score = int(item.get("risk_score", 0) or 0)

            if risk_score >= risk_threshold and hunk_id:
                targets.append({
                    "hunk_id": hunk_id,
                    "risk_score": risk_score,
                    "reason": "top_focus",
                    "priority": item.get("priority", "medium")
                })

    if len(targets) < max_units:
        for feature in feature_risk_plan.get("features", []):
            for hunk in feature.get("hunks", []):
                hunk_id = hunk.get("hunk_id")
                risk_score = int(hunk.get("risk_score", 0) or 0)

                if risk_score >= risk_threshold and hunk_id and len(targets) < max_units:
                    targets.append({
                        "hunk_id": hunk_id,
                        "risk_score": risk_score,
                        "reason": "feature_hunks",
                        "priority": hunk.get("severity", "medium")
                    })

    return targets[:max_units]


def build_audit_unit_from_hunk(hunk_id: str, hunk: Dict[str, Any], code_tools, target_info: Dict[str, Any] = None) -> Dict[str, Any]:
    """从hunk详情构建审计单元"""
    file_path = hunk.get("file_path")
    language = hunk.get("language", "Unknown")
    hunk_obj = hunk.get("hunk") or {}
    hunk_text = hunk_text_from_diff_hunk(hunk_obj)
    hunk_with_lines = format_hunk_for_prompt_with_line_numbers(file_path=file_path, hunk=hunk_obj)
    line_candidates = build_line_candidates_from_hunk(hunk_obj)

    new_line_min, new_line_max = get_hunk_line_range(hunk.get("hunk"))
    snippet = ""
    snippet_start_line = 1
    context_lines = 0

    if new_line_min is not None and new_line_max is not None:
        start = max(1, new_line_min - 50)
        end = new_line_max + 50
        max_end = start + 200
        snippet_start_line = start

        rf = code_tools.read_file(file_path, start_line=start, end_line=min(end, max_end))
        if rf.get("success"):
            snippet = rf.get("content", "")
            context_lines = min(end - start + 1, 200)
        else:
            rf = code_tools.read_file(file_path, start_line=1, end_line=200)
            if rf.get("success"):
                snippet = rf.get("content", "")
                context_lines = 200

    return {
        "hunk_id": hunk_id,
        "file_path": file_path,
        "language": language,
        "risk_score": target_info.get("risk_score", 0) if target_info else 0,
        "functional_change": hunk_text[:200] + ("..." if len(hunk_text) > 200 else ""),
        "diff_hunk": hunk_text,
        "diff_hunk_with_line_numbers": hunk_with_lines,
        "code_context": {
            "new_line_range": [new_line_min, new_line_max],
            "snippet": snippet[:1800],  # 限制上下文长度
            "snippet_start_line": snippet_start_line,
            "snippet_with_line_numbers": format_snippet_with_line_numbers(
                snippet=snippet[:1800],
                start_line=snippet_start_line,
            ) if snippet else "",
            "context_lines": context_lines
        },
        "line_candidates": line_candidates,
        "hints": {
            "selection_reason": target_info.get("reason", "unknown") if target_info else "unknown",
            "priority": target_info.get("priority", "medium") if target_info else "medium",
            **(target_info or {})
        }
    }