"""
Hunkç´¢å¼•æ¨¡å— - å»ºç«‹feature_risk_planä¸diff_irä¹‹é—´çš„æ˜ å°„å…³ç³»
ç”¨äºè§£å†³è°ƒåº¦é€‰æ‹©é˜¶æ®µå­—æ®µä¸åŒ¹é…çš„é—®é¢˜
"""

from typing import Any, Dict, List, Optional, Tuple


def build_hunk_index(diff_ir: Dict[str, Any]) -> Dict[str, Dict[str, Any]]:
    """
    ä»diff_iræ„å»ºhunk_idåˆ°è¯¦æƒ…çš„æ˜ å°„

    Args:
        diff_ir: diff_iræ•°æ®ç»“æ„

    Returns:
        Dict: hunk_id -> hunkè¯¦æƒ…çš„æ˜ å°„å­—å…¸
    """
    index: Dict[str, Dict[str, Any]] = {}
    files = diff_ir.get("files", [])

    for f_idx, f in enumerate(files):
        file_path = f.get("file_path")
        language = f.get("language")
        change_type = f.get("change_type")
        is_binary = f.get("is_binary", False)

        for h_idx, h in enumerate(f.get("hunks", [])):
            hid = f"{f_idx}:{h_idx}"
            index[hid] = {
                "hunk_id": hid,
                "file_path": file_path,
                "language": language,
                "change_type": change_type,
                "is_binary": is_binary,
                "hunk": h,
                "old_start": h.get("old_start"),
                "old_count": h.get("old_count"),
                "new_start": h.get("new_start"),
                "new_count": h.get("new_count"),
                "header": h.get("header", "")
            }

    return index


def hunk_text_from_diff_hunk(hunk: Dict[str, Any], max_lines: int = 160) -> str:
    """
    ä»diff_irçš„hunkç»“æ„æå–æ–‡æœ¬å†…å®¹

    Args:
        hunk: diff_irä¸­çš„hunkå¯¹è±¡
        max_lines: æœ€å¤§è¡Œæ•°é™åˆ¶

    Returns:
        str: hunkçš„æ–‡æœ¬å†…å®¹
    """
    lines = hunk.get("lines", [])
    out = []

    for ln in lines[:max_lines]:
        content = ln.get("content", "")
        if content:
            # æ·»åŠ è¡Œå‰ç¼€è¡¨ç¤ºå˜æ›´ç±»å‹
            line_type = ln.get("type", "")
            if line_type == "add":
                prefix = "+"
            elif line_type == "del":
                prefix = "-"
            else:
                prefix = " "

            old_no = ln.get("old_lineno")
            new_no = ln.get("new_lineno")

            out.append(f"{prefix} (old:{old_no}, new:{new_no}) {content}")

    return "\n".join(out)


def extract_new_lines(hunk: Dict[str, Any]) -> List[int]:
    """
    æå–hunkä¸­çš„æ–°å¢è¡Œå·

    Args:
        hunk: diff_irä¸­çš„hunkå¯¹è±¡

    Returns:
        List[int]: æ–°å¢è¡Œå·åˆ—è¡¨
    """
    new_lines = []

    for ln in hunk.get("lines", []):
        if ln.get("type") == "add" and ln.get("new_lineno"):
            new_lines.append(ln["new_lineno"])

    return new_lines


def get_hunk_line_range(hunk: Dict[str, Any]) -> Tuple[Optional[int], Optional[int]]:
    """
    ğŸ”§ æ”¹è¿›ï¼šè·å–å®Œæ•´ hunk èŒƒå›´ï¼ˆåŒ…æ‹¬ context è¡Œï¼‰

    ä½¿ç”¨ hunk å…ƒæ•°æ®ï¼ˆnew_start, new_countï¼‰è€Œéä»…ç»Ÿè®¡æ–°å¢è¡Œï¼Œ
    è¿™æ · build_audit_unit_from_hunk() è¯»å–çš„ snippet èƒ½ç¨³å®šè¦†ç›– guard/åˆ†æ”¯æ¡ä»¶ã€‚

    Args:
        hunk: diff_irä¸­çš„hunkå¯¹è±¡

    Returns:
        Tuple[Optional[int], Optional[int]]: (æœ€å°è¡Œå·, æœ€å¤§è¡Œå·)
    """
    # æ–¹æ³• 1: ä½¿ç”¨ hunk å…ƒæ•°æ®ï¼ˆæœ€å‡†ç¡®ï¼ŒåŒ…å«å®Œæ•´ hunk èŒƒå›´ï¼‰
    new_start = hunk.get("new_start")
    new_count = hunk.get("new_count", 0)

    if new_start is not None and new_count > 0:
        return new_start, new_start + new_count - 1

    # Fallback: å¦‚æœæ²¡æœ‰ metadataï¼Œæ‰ç»Ÿè®¡ added lines
    new_lines = extract_new_lines(hunk)
    if new_lines:
        return min(new_lines), max(new_lines)

    return None, None


def get_hunk_risk_score(hunk: Dict[str, Any], feature_risk_plan: Dict[str, Any]) -> int:
    """
    ä»feature_risk_planä¸­æŸ¥æ‰¾hunkçš„é£é™©åˆ†æ•°

    Args:
        hunk: diff_irä¸­çš„hunkå¯¹è±¡
        feature_risk_plan: é£é™©åˆ†æç»“æœ

    Returns:
        int: é£é™©åˆ†æ•°
    """
    hunk_id = hunk.get("hunk_id")

    # åœ¨featuresä¸­æŸ¥æ‰¾hunk
    for feature in feature_risk_plan.get("features", []):
        for h in feature.get("hunks", []):
            if h.get("hunk_id") == hunk_id:
                return int(h.get("risk_score", 0))

    return 0


def get_hunk_severity(hunk: Dict[str, Any], feature_risk_plan: Dict[str, Any]) -> str:
    """
    ä»feature_risk_planä¸­æŸ¥æ‰¾hunkçš„ä¸¥é‡æ€§çº§åˆ«

    Args:
        hunk: diff_irä¸­çš„hunkå¯¹è±¡
        feature_risk_plan: é£é™©åˆ†æç»“æœ

    Returns:
        str: ä¸¥é‡æ€§çº§åˆ«
    """
    hunk_id = hunk.get("hunk_id")

    # åœ¨featuresä¸­æŸ¥æ‰¾hunk
    for feature in feature_risk_plan.get("features", []):
        for h in feature.get("hunks", []):
            if h.get("hunk_id") == hunk_id:
                return h.get("severity", "info")

    return "info"


def filter_hunks_by_risk(hunks: List[Dict[str, Any]], risk_threshold: int = 35) -> List[Dict[str, Any]]:
    """
    æŒ‰é£é™©é˜ˆå€¼è¿‡æ»¤hunks

    Args:
        hunks: hunkåˆ—è¡¨
        risk_threshold: é£é™©é˜ˆå€¼

    Returns:
        List[Dict[str, Any]]: è¿‡æ»¤åçš„hunkåˆ—è¡¨
    """
    return [h for h in hunks if int(h.get("risk_score", 0)) >= risk_threshold]


def select_hunks_from_top_focus(feature_risk_plan: Dict[str, Any], risk_threshold: int = 35, max_units: int = 10) -> List[str]:
    """
    ä»top_focusä¸­é€‰æ‹©hunk_id

    Args:
        feature_risk_plan: é£é™©åˆ†æç»“æœ
        risk_threshold: é£é™©é˜ˆå€¼
        max_units: æœ€å¤§å•å…ƒæ•°

    Returns:
        List[str]: é€‰æ‹©çš„hunk_idåˆ—è¡¨
    """
    selected = []

    for item in feature_risk_plan.get("top_focus", []):
        hunk_id = item.get("hunk_id")
        risk_score = int(item.get("risk_score", 0) or 0)

        if risk_score >= risk_threshold and hunk_id and len(selected) < max_units:
            selected.append(hunk_id)

    return selected


def select_hunks_from_features(feature_risk_plan: Dict[str, Any], risk_threshold: int = 35, max_units: int = 10) -> List[str]:
    """
    ä»featuresä¸­é€‰æ‹©hunk_id

    Args:
        feature_risk_plan: é£é™©åˆ†æç»“æœ
        risk_threshold: é£é™©é˜ˆå€¼
        max_units: æœ€å¤§å•å…ƒæ•°

    Returns:
        List[str]: é€‰æ‹©çš„hunk_idåˆ—è¡¨
    """
    selected = []

    for feature in feature_risk_plan.get("features", []):
        for hunk in feature.get("hunks", []):
            hunk_id = hunk.get("hunk_id")
            risk_score = int(hunk.get("risk_score", 0) or 0)

            if risk_score >= risk_threshold and hunk_id and len(selected) < max_units:
                selected.append(hunk_id)

    return selected


def select_security_targets(feature_risk_plan: Dict[str, Any], risk_threshold: int = 35, max_units: int = 10) -> List[Dict[str, Any]]:
    """
    é€‰æ‹©Security Agentçš„ç›®æ ‡hunks

    Args:
        feature_risk_plan: é£é™©åˆ†æç»“æœ
        risk_threshold: é£é™©é˜ˆå€¼
        max_units: æœ€å¤§å•å…ƒæ•°

    Returns:
        List[Dict[str, Any]]: é€‰æ‹©çš„ç›®æ ‡ä¿¡æ¯åˆ—è¡¨
    """
    targets = []

    # ä¼˜å…ˆä½¿ç”¨top_focus
    if feature_risk_plan.get("top_focus"):
        for item in feature_risk_plan["top_focus"]:
            hunk_id = item.get("hunk_id")
            risk_score = int(item.get("risk_score", 0) or 0)

            if risk_score >= risk_threshold and hunk_id:
                targets.append({
                    "hunk_id": hunk_id,
                    "risk_score": risk_score,
                    "reason": "top_focus",
                    "priority": item.get("priority", "medium")
                })

    # å¦‚æœtop_focusä¸ºç©ºæˆ–æ•°é‡ä¸è¶³ï¼Œåˆ™ä»featuresä¸­é€‰æ‹©
    if len(targets) < max_units:
        for feature in feature_risk_plan.get("features", []):
            for hunk in feature.get("hunks", []):
                hunk_id = hunk.get("hunk_id")
                risk_score = int(hunk.get("risk_score", 0) or 0)

                if risk_score >= risk_threshold and hunk_id and len(targets) < max_units:
                    targets.append({
                        "hunk_id": hunk_id,
                        "risk_score": risk_score,
                        "reason": "feature_hunks",
                        "priority": hunk.get("severity", "medium")
                    })

    return targets[:max_units]


def select_logic_targets(feature_risk_plan: Dict[str, Any], risk_threshold: int = 60, max_units: int = 12) -> List[Dict[str, Any]]:
    """
    é€‰æ‹©Logic Agentçš„ç›®æ ‡hunks

    Args:
        feature_risk_plan: é£é™©åˆ†æç»“æœ
        risk_threshold: é£é™©é˜ˆå€¼
        max_units: æœ€å¤§å•å…ƒæ•°

    Returns:
        List[Dict[str, Any]]: é€‰æ‹©çš„ç›®æ ‡ä¿¡æ¯åˆ—è¡¨
    """
    targets = []

    # Logic Agentä¼˜å…ˆä½¿ç”¨top_focus
    if feature_risk_plan.get("top_focus"):
        for item in feature_risk_plan["top_focus"]:
            hunk_id = item.get("hunk_id")
            risk_score = int(item.get("risk_score", 0) or 0)

            if risk_score >= risk_threshold and hunk_id:
                targets.append({
                    "hunk_id": hunk_id,
                    "risk_score": risk_score,
                    "reason": "top_focus",
                    "priority": item.get("priority", "medium")
                })

    # å¦‚æœtop_focusä¸ºç©ºæˆ–æ•°é‡ä¸è¶³ï¼Œåˆ™ä»featuresä¸­é€‰æ‹©
    if len(targets) < max_units:
        for feature in feature_risk_plan.get("features", []):
            for hunk in feature.get("hunks", []):
                hunk_id = hunk.get("hunk_id")
                risk_score = int(hunk.get("risk_score", 0) or 0)

                if risk_score >= risk_threshold and hunk_id and len(targets) < max_units:
                    targets.append({
                        "hunk_id": hunk_id,
                        "risk_score": risk_score,
                        "reason": "feature_hunks",
                        "priority": hunk.get("severity", "medium")
                    })

    return targets[:max_units]


def build_audit_unit_from_hunk(hunk_id: str, hunk: Dict[str, Any], code_tools, target_info: Dict[str, Any] = None) -> Dict[str, Any]:
    """
    ä»hunkè¯¦æƒ…æ„å»ºå®¡è®¡å•å…ƒ

    Args:
        hunk_id: hunk ID
        hunk: hunkè¯¦æƒ…
        code_tools: ä»£ç å·¥å…·å®ä¾‹
        target_info: ç›®æ ‡ä¿¡æ¯

    Returns:
        Dict: å®¡è®¡å•å…ƒ
    """
    file_path = hunk.get("file_path")
    language = hunk.get("language", "Unknown")
    hunk_text = hunk_text_from_diff_hunk(hunk.get("hunk"))

    # è·å–æ–°å¢è¡Œå·èŒƒå›´
    new_line_min, new_line_max = get_hunk_line_range(hunk.get("hunk"))

    # è¯»å–ä»£ç ä¸Šä¸‹æ–‡
    snippet = ""
    context_lines = 0

    if new_line_min is not None and new_line_max is not None:
        start = max(1, new_line_min - 50)
        end = new_line_max + 50
        max_end = start + 200

        rf = code_tools.read_file(file_path, start_line=start, end_line=min(end, max_end))
        if rf.get("success"):
            snippet = rf.get("content", "")
            context_lines = min(end - start + 1, 200)
        else:
            rf = code_tools.read_file(file_path, start_line=1, end_line=200)
            if rf.get("success"):
                snippet = rf.get("content", "")
                context_lines = 200

    return {
        "hunk_id": hunk_id,
        "file_path": file_path,
        "language": language,
        "risk_score": target_info.get("risk_score", 0) if target_info else 0,
        "functional_change": hunk_text[:200] + ("..." if len(hunk_text) > 200 else ""),
        "diff_hunk": hunk_text,
        "code_context": {
            "new_line_range": [new_line_min, new_line_max],
            "snippet": snippet[:1800],  # é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦
            "context_lines": context_lines
        },
        "hints": {
            "selection_reason": target_info.get("reason", "unknown") if target_info else "unknown",
            "priority": target_info.get("priority", "medium") if target_info else "medium",
            **(target_info or {})
        }
    }