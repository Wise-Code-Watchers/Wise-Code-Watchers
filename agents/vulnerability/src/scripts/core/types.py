"""
初始化阶段类型定义
控输入、立边界、降误报
"""

from typing import List, Dict, Any, Optional, TypedDict
from enum import Enum
import uuid


class SymbolType(Enum):
    """符号类型枚举"""
    FUNCTION = "function"
    METHOD = "method"
    CLASS = "class"
    CONFIG = "config"
    GLOBAL = "global"
    UNKNOWN = "unknown"


class ImpactLevel(Enum):
    """影响级别枚举"""
    NONE = "none"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"


class DecisionType(Enum):
    """初始化决策类型"""
    PASS = "pass"     # 进入深度审查
    SKIP = "skip"     # 跳过审查


class AuditUnit(TypedDict, total=False):
    """审计单元定义 - 可审计的最小单元"""
    # 唯一标识
    id: str

    # diff 核心
    file_path: str
    language: str
    diff_hunk: str

    # 代码结构
    symbol: Dict[str, Any]  # 包含 type, name, signature等

    # 影响范围
    impact: Dict[str, bool]  # control_flow, data_flow, security_surface, model_prompt

    # 元信息
    is_test_code: bool
    is_generated: bool

    # 审计信息
    hunk_id: Optional[str]
    line_start: Optional[int]
    line_end: Optional[int]


class InitializationResult(TypedDict, total=False):
    """初始化结果"""
    success: bool
    audit_units: List[AuditUnit]
    total_units: int
    passed_units: int
    skipped_units: int
    skipped_reasons: Dict[str, int]  # 原因统计
    processing_time: float


class ContextRequirement(TypedDict, total=False):
    """上下文需求"""
    required_context: List[str]  # symbol, config, data_flow, call_graph


class InitializationDecision(TypedDict, total=False):
    """初始化决策"""
    decision: str  # "pass" 或 "skip"
    reason: str   # 判断依据（仅基于事实）
    required_context: List[str]
    confidence: float  # 判断置信度


# 事实抽取相关的类型定义
class SymbolInfo(TypedDict, total=False):
    """符号信息"""
    type: str
    name: str
    signature: Optional[str]
    line_number: int
    column_number: int


class ImpactAnalysis(TypedDict, total=False):
    """影响分析结果"""
    control_flow: bool
    data_flow: bool
    security_surface: bool
    model_prompt: bool
    file_system: bool
    network_io: bool
    database_access: bool


class FileAnalysis(TypedDict, total=False):
    """文件分析结果"""
    file_path: str
    language: str
    is_test_file: bool
    is_generated: bool
    total_lines: int
    has_imports: bool
    has_exports: bool
    complexity_metrics: Dict[str, int]


# 导出主要类型
__all__ = [
    "AuditUnit",
    "InitializationResult",
    "InitializationDecision",
    "ContextRequirement",
    "SymbolType",
    "ImpactLevel",
    "DecisionType",
    "SymbolInfo",
    "ImpactAnalysis",
    "FileAnalysis"
]